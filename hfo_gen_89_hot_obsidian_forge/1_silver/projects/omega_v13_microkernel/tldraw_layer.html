<!DOCTYPE html>
<!--
  tldraw_layer.html — Omega v13 Layer 2: WYSIWYG tldraw whiteboard

  Loaded inside <iframe> at z=20, opacity=0.8.
  Receives SYNTHETIC_POINTER_EVENT postMessages from W3CPointerFabric and
  re-dispatches them as real PointerEvents into the tldraw React tree.

  tldraw + React are loaded from LOCAL builds (dist/tldraw_bundle.js) to
  guarantee a single react instance — no CDN version-mismatch issues.

  Build: npx esbuild tldraw_entrypoint.tsx --bundle --outfile=dist/tldraw_bundle.js
         --format=iife --platform=browser --target=chrome120
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Omega v13 – tldraw Layer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #tldraw-root {
      width: 100%; height: 100%;
      background: transparent !important;
      overflow: hidden;
    }
    .tl-background { background: transparent !important; }
  </style>
  <!-- tldraw CSS — built locally alongside tldraw_bundle.js -->
  <link rel="stylesheet" href="./dist/tldraw_bundle.css" />
</head>
<body>
  <div id="tldraw-root"></div>

  <!-- Local IIFE bundle: react + react-dom + tldraw all in one file -->
  <script src="./dist/tldraw_bundle.js?v=3"></script>

  <script>
    // ── Omega v13 Symbiote Agent ─────────────────────────────────────────────
    window.addEventListener('message', function omegaSymbiote(e) {
      if (!e.data || e.data.type !== 'SYNTHETIC_POINTER_EVENT') return;

      const { eventType, eventInit } = e.data;
      const { clientX, clientY } = eventInit;

      const target = document.elementFromPoint(clientX, clientY);
      if (!target) return;

      const evt = new PointerEvent(eventType, {
        bubbles:      true,
        cancelable:   true,
        composed:     true,
        pointerId:    eventInit.pointerId   || 10000,
        pointerType:  eventInit.pointerType || 'touch',
        isPrimary:    eventInit.isPrimary    ?? true,
        clientX,
        clientY,
        screenX:      clientX,
        screenY:      clientY,
        buttons:      eventInit.buttons     ?? 0,
        pressure:     eventInit.pressure    ?? 0,
      });

      target.dispatchEvent(evt);
    });

    window.addEventListener('message', function omegaWheel(e) {
      if (!e.data || e.data.type !== 'SYNTHETIC_WHEEL_EVENT') return;
      const { clientX, clientY, deltaX, deltaY, deltaZ, deltaMode } = e.data;
      const target = document.elementFromPoint(clientX, clientY);
      if (!target) return;
      const wEvt = new WheelEvent('wheel', {
        bubbles: true, cancelable: true, composed: true,
        clientX, clientY, deltaX, deltaY, deltaZ: deltaZ ?? 0, deltaMode: deltaMode ?? 0,
      });
      target.dispatchEvent(wEvt);
    });

    console.log('[tldraw-layer] Symbiote agent active');
  </script>
</body>
</html>
